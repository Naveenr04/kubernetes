{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "resourceTypes": [
            "microsoft.containerservice/managedclusters",
            "microsoft.sql/servers",
            "microsoft.storage/storageaccounts",
            "microsoft.resources/deploymentscripts",
            "microsoft.resources/resourcegroups"
        ],
        "isWizard": true,
        "basics": [            
        ],
        "steps": [ {
            "name": "profisee",
            "label": "Profisee",
            "elements": [
                {
                    "name": "ProfiseeVersion",
                    "type": "Microsoft.Common.DropDown",
                    "label": "Version",
                    "defaultValue": "2020R2.0",
                    "toolTip": "Version of the Profisee platform to use.",
                    "constraints": {
                        "required": false,
                        "allowedValues": [
                            {
                                "label": "2020R1.0",
                                "value": "2020R1.0"
                            },
                            {
                                "label": "2020R1.1",
                                "value": "2020R1.1"
                            },
                            {
                                "label": "2020R2.0",
                                "value": "2020R2.0"
                            }
                        ]
                    },
                    "visible": true
                },
                {
                    "name": "ProfiseeAdminUserAccount",
                    "type": "Microsoft.Common.TextBox",
                    "label": "Admin User Account",
                    "defaultValue": "first.last@company.com",
                    "toolTip": "Name of the account of the first super user who will be registered in the Profisee platform, who will be able to logon and add other users.",
                    "constraints": {
                        "required": false,
                        "regex": "",
                        "validationMessage": ""
                    },
                    "visible": true
                },
                {
                    "name": "ProfiseeLicense",
                    "type": "Microsoft.Common.TextBox",
                    "label": "License",
                    "defaultValue": "",
                    "toolTip": "Profisee plaform license string supplied by Profisee support.",
                    "constraints": {
                        "required": true,
                        "regex": "",
                        "validationMessage": ""
                    },
                    "visible": true
                }
            ]
        },
        {
            "name": "ad",
            "label": "Active Directory",
            "elements": [ 
                {
                    "name": "ActiveDirectoryCreateApp",
                    "type": "Microsoft.Common.OptionsGroup",
                    "label": "Do you want the deployment process to create an Azure application registration and configure it for you?",
                    "defaultValue": "Yes, create and configure the Azure application registration.",
                    "toolTip": "",
                    "constraints": {
                      "allowedValues": [
                        {
                          "label": "Yes, create and configure the Azure application registration.",
                          "value": "Yes"
                        },
                        {
                          "label": "No, I want to supply an existing azure application registration client id.",
                          "value": "No"
                        }
                      ],
                      "required": true
                    },
                    "visible": true
                }, 
                {
                    "name": "UserSuppliedClientyId",
                    "type": "Microsoft.Common.Section",
                    "label": "",
                    "elements": [
                        {
                            "name": "ActiveDirectoryClientId",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Application Registration Client Id",
                            "defaultValue": "",
                            "toolTip": "ClientId of existing Azure Active Directory App Registration which will be used by the profisee platform for authentication.",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": ""
                            },
                            "visible": true
                        }
                    ],
                    "visible": "[equals(steps('ad').ActiveDirectoryCreateApp,'No')]"
                },
                {
                    "name": "ManagedIdentityName",
                    "type": "Microsoft.ManagedIdentity.IdentitySelector",
                    "label": "Managed Identity Configuration",
                    "toolTip": {
                        "systemAssignedIdentity": "Enable system assigned identity to grant the resource access to other existing resources.",
                        "userAssignedIdentity": "Add user assigned identities to grant the resource access to other existing resources."
                    },
                    "defaultValue": {
                        "systemAssignedIdentity": "OffOnly"
                    },
                    "options": {
                        "hideSystemAssignedIdentity": true,
                        "hideUserAssignedIdentity": false
                    }
                }                          
            ]
        },            
        {
            "name": "kubernetes",
            "label": "Kubernetes",
            "elements": [
                {
                    "name": "KubernetesClusterName",
                    "type": "Microsoft.Common.TextBox",
                    "label": "Cluster Name",
                    "defaultValue": "MyAKSCluster",
                    "toolTip": "Name of the kubernetes cluster to create.  The name can contain only letters, numbers, underscores and hyphens. The name must start and end with letter or number. The name must be unique in the current resource group",
                    "constraints": {
                        "required": false,
                        "regex": "",
                        "validationMessage": ""
                    },
                    "visible": true
                },               
                {
                    "name": "KubernetesLinuxNodeSizeSection",
                    "type": "Microsoft.Common.Section",
                    "label": "Linux VM",
                    "elements": [
                        {
                            "name": "KubernetesLinuxNodeSize",
                            "type": "Microsoft.Compute.SizeSelector",
                            "label": "Size",
                            "toolTip": "",
                            "recommendedSizes": [
                                "Standard_D2s_v3"
                            ],
                            "constraints": {
                                "allowedSizes": []
                            },
                            "options": {
                                "hideDiskTypeFilter": false
                            },
                            "osPlatform": "Linux",
                            "count": 1,
                            "visible": true
                        }
                    ],
                    "visible": true
                },   
                {
                    "name": "KubernetesLinuxNodeCount",
                    "type": "Microsoft.Common.Slider",
                    "min": 1,
                    "max": 12,
                    "label": "Linux node count",
                    "subLabel": "",
                    "defaultValue": 1,
                    "showStepMarkers": false,
                    "toolTip": "Pick the amount of nodes",
                    "constraints": {
                        "required": false
                    },
                    "visible": true
                },           
                {
                    "name": "KubernetesWindowsNodeSizeSection",
                    "type": "Microsoft.Common.Section",
                    "label": "Windows VM",
                    "elements": [
                        {
                            "name": "KubernetesWindowsNodeSize",
                            "type": "Microsoft.Compute.SizeSelector",
                            "label": "Size",
                            "toolTip": "",
                            "recommendedSizes": [
                                "Standard_D4s_v3"
                            ],
                            "constraints": {
                                "allowedSizes": []
                            },
                            "options": {
                                "hideDiskTypeFilter": false
                            },
                            "osPlatform": "Windows",
                            "imageReference": {
                                "publisher": "MicrosoftWindowsServer",
                                "offer": "WindowsServer",
                                "sku": "2019-Datacenter"
                            },
                            "count": 1,
                            "visible": true
                        }
                    ],
                    "visible": true
                },
                {
                    "name": "KubernetesWindowsNodeCount",
                    "type": "Microsoft.Common.Slider",
                    "min": 1,
                    "max": 12,
                    "label": "Windows node count",
                    "subLabel": "",
                    "defaultValue": 1,
                    "showStepMarkers": false,
                    "toolTip": "Pick the amount of nodes",
                    "constraints": {
                        "required": false
                    },
                    "visible": true
                },  
                {
                    "name": "KubernetesAdvancedYesNo",
                    "type": "Microsoft.Common.OptionsGroup",
                    "label": "Do you need to configure advanced kubernetes neteworking settings, vnet's, subnets, etc..",
                    "defaultValue": "No, use default settings.",
                    "toolTip": "",
                    "constraints": {
                      "allowedValues": [
                        {
                          "label": "No, use default settings.",
                          "value": "No"
                        },
                        {
                          "label": "Yes, configure advanced settings",
                          "value": "Yes"
                        }
                      ],
                      "required": true
                    },
                    "visible": true
                }, 
                {
                    "name": "KubernetesAdvanced",
                    "type": "Microsoft.Common.Section",
                    "label": "Advanced kubernetes settings",
                    "elements": [
                        {
                            "name": "VNet name",
                            "type": "Microsoft.Network.VirtualNetworkCombo",
                            "label": {
                                "virtualNetwork": "Virtual network",
                                "subnets": "Subnets"
                            },
                            "toolTip": {
                                "virtualNetwork": "",
                                "subnets": ""
                            },
                            "defaultValue": {
                                "name": "vnet01",
                                "addressPrefixSize": "/16"
                            },
                            "constraints": {
                                "minAddressPrefixSize": "/16"
                            },
                            "options": {
                                "hideExisting": false
                            },
                            "subnets": {
                                "subnet1": {
                                    "label": "Subnet",
                                    "defaultValue": {
                                        "name": "subnet-1",
                                        "addressPrefixSize": "/24"
                                    },
                                    "constraints": {
                                        "minAddressPrefixSize": "/24",
                                        "minAddressCount": 12,
                                        "requireContiguousAddresses": true
                                    }
                                }
                            },
                            "visible": true
                        },
                        {
                            "name": "KubernetesServiceCidr",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Service Cidr",
                            "defaultValue": "10.0.0.0/16",
                            "toolTip": "A CIDR notation IP range from which to assign service cluster IPs.",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": ""
                            },
                            "visible": true
                        },
                        {
                            "name": "KubernetesDNSServiceIP",
                            "type": "Microsoft.Common.TextBox",
                            "label": "DNS Service IP",
                            "defaultValue": "10.0.0.10",
                            "toolTip": "Containers DNS server IP address.",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": ""
                            },
                            "visible": true
                        },
                        {
                            "name": "KubernetesDockerBridgeCidr",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Docker Bridge Cidr",
                            "defaultValue": "172.17.0.1/16",
                            "toolTip": "A CIDR notation IP for Docker bridge.",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": ""
                            },
                            "visible": true
                        }
                    ],
                    "visible": "[equals(steps('kubernetes').KubernetesAdvancedYesNo,'Yes')]"
                }         
                
            ]
        },        
        {
            "name": "sql",
            "label": "SQL",
            "elements": [
                {
                    "name": "SQLServerCreateNew",
                    "type": "Microsoft.Common.OptionsGroup",
                    "label": "Do you want the deployment process to create an SQL Server and configure it for you?",
                    "defaultValue": "Yes, create a new SQL server",
                    "toolTip": "If you select No, you must enter the FQDN of an existing sql server accessable by this azure subscription",
                    "constraints": {
                        "required": false,
                        "allowedValues": [
                            {
                                "label": "Yes, create a new SQL server",
                                "value": "Yes"
                            },
                            {
                                "label": "No, I will provide the fully qualified name of the existing SQL Server",
                                "value": "No"
                            }
                        ]
                    },
                    "visible": true
                },
                {
                    "name": "sql servers",
                    "type": "Microsoft.Solutions.ResourceSelector",
                    "label": "Select storage accounts",
                    "resourceType": "Microsoft.Sql/servers",
                    "options": {
                        "filter": {
                            "subscription": "All",
                            "location": "All"
                        }
                    },
                    "visible": "[equals(steps('sql').SQLServerCreateNew,'No')]"
                },
                {
                    "name": "SQLServerName",
                    "type": "Microsoft.Common.TextBox",
                    "label": "Server Name",
                    "defaultValue": "mysqlservername",
                    "toolTip": "Enter a unique sql server name.  Can contain only lowercase letters, numbers, and '-', but can't start or end with '-' or have more than 63 characters and be an available sqlserver name in azure.  SQL Server names are globally unique in Azure",
                    "constraints": {
                        "required": false,
                        "regex": "",
                        "validationMessage": ""
                    },
                    "visible": true
                },
                {
                    "name": "SQLServerUser",
                    "type": "Microsoft.Common.TextBox",
                    "label": "User",
                    "defaultValue": "sqladmin",
                    "toolTip": "Administrator SQL login name to create with the new sql server or to use to connect to existing sql server.  Your login name must not contain a SQL Identifier or a typical system name (like admin, administrator, sa, root, dbmanager, loginmanager, etc.) or a built-in database user or role (like dbo, guest, public, etc.).  Your login name must not include non-alphanumeric characters.  Your login name must not start with numbers or symbols",
                    "constraints": {
                        "required": false,
                        "regex": "",
                        "validationMessage": ""
                    },
                    "visible": true
                },
                {
                    "name": "SQLServerPassword",
                    "type": "Microsoft.Common.PasswordBox",
                    "label": {
                        "password": "Password",
                        "confirmPassword": "Confirm password"
                    },
                    "toolTip": "Password for sql server user.  The password does not contain the account name of the user and must be at least eight characters long and be no more than 128 characters in length.  The password contains characters from three of the following four categories: Latin uppercase letters (A through Z).  Latin lowercase letters (a through z).  Base 10 digits (0 through 9).  Non-alphanumeric characters such as: exclamation point (!), dollar sign ($), number sign (#), or percent (%).",
                    "constraints": {
                        "required": true,
                        "regex": "",
                        "validationMessage": ""
                    },
                    "options": {
                        "hideConfirmation": "[equals(steps('sql').SQLServerCreateNew,'No')]"
                    },
                    "visible": true
                },
                {
                    "name": "SQLServerDatabaseName",
                    "type": "Microsoft.Common.TextBox",
                    "label": "Database Name",
                    "defaultValue": "Profisee",
                    "toolTip": "Name of database to create and/or use.  Name should not match special pattern and has a length of at most 128.  Should not contain reserved words.  No database with the same name exists in the server",
                    "constraints": {
                        "required": false,
                        "regex": "",
                        "validationMessage": ""
                    },
                    "visible": "[equals(steps('sql').SQLServerCreateNew,'No')]"
                }
            ]
        },  
        {
            "name": "storage",
            "label": "Storage",
            "elements": [
                
                {
                    "name": "StorageAccountNameSection",
                    "type": "Microsoft.Common.Section",
                    "label": "Storage Account Name",
                    "elements": [
                        {
                            "name": "StorageAccountName",
                                "type": "Microsoft.Storage.StorageAccountSelector",
                                "label": "Storage account",
                                "toolTip": "",
                                "defaultValue": {
                                    "name": "uniquestorageaccount01",
                                    "type": "Premium_LRS"
                                },
                                "constraints": {
                                    "allowedTypes": []
                                },
                                "options": {
                                    "hideExisting": false
                                },
                                "visible": true
                        }
                    ],
                    "visible": true
                }
            ]
        },          
        {
            "name": "dns",
            "label": "DNS",
            "elements": [
                {
                    "name": "DNSUpdate",
                    "type": "Microsoft.Common.OptionsGroup",
                    "label": "You can choose to use azure dns or user defined dns",
                    "defaultValue": "Use Azure DNS.  myprofisee.(reqion).cloudapps.azure.com",
                    "toolTip": "",
                    "constraints": {
                      "allowedValues": [
                        {
                          "label": "Use Azure DNS.  myprofisee.(reqion).cloudapps.azure.com",
                          "value": "No"
                        },
                        {
                          "label": "Use my own DNS hostname and domain name",
                          "value": "Yes"
                        }
                      ],
                      "required": true
                    },
                    "visible": true
                },
                {
                    "name": "UserDefinedDNS",
                    "type": "Microsoft.Common.Section",
                    "label": "User Defined DNS",
                    "elements": [
                        {
                            "name": "DNSHostName",
                            "type": "Microsoft.Common.TextBox",
                            "label": "DNS Host Name",
                            "defaultValue": "myprofiseehostname",
                            "toolTip": "Host name to use/create.  Required if updating DNS.",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": ""
                            },
                            "visible": true
                        },
                        {
                            "name": "DNSDomainName",
                            "type": "Microsoft.Common.TextBox",
                            "label": "DNS Domain Name",
                            "defaultValue": "mydomain.com",
                            "toolTip": "Domain name name to use.  Required if updating DNS.",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": ""
                            },
                            "visible": true
                        },
                        {
                            "name": "DNSDomainResourceGroup",
                            "type": "Microsoft.Common.TextBox",
                            "label": "DNS Domain Resource Group",
                            "defaultValue": "mydnszoneresourcegroup",
                            "toolTip": "Resource group that the DNS zone (Domain name) is in.  Required if updating DNS.",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": ""
                            },
                            "visible": true
                        }
                    ],
                    "visible": "[equals(steps('dns').DNSUpdate,'Yes')]"
                }
                
                
            ]
        },{
            "name": "https",
            "label": "Https",
            "elements": [
                {
                    "name": "HttpsConfigure",
                    "type": "Microsoft.Common.OptionsGroup",
                    "label": "You can choose to use Let's Encrypt for https or supply your own certificates",
                    "defaultValue": "Use Let's Encrypt",
                    "toolTip": "",
                    "constraints": {
                      "allowedValues": [
                        {
                          "label": "Use Let's Encrypt",
                          "value": "No"
                        },
                        {
                          "label": "Use my own certificates",
                          "value": "Yes"
                        }
                      ],
                      "required": true
                    },
                    "visible": true
                },
                {
                    "name": "UserDefinedHTTPS",
                    "type": "Microsoft.Common.Section",
                    "label": "User defined https",
                    "elements": [
                        {
                            "name": "HttpsCertificate",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Https Certificate",
                            "defaultValue": "",
                            "toolTip": "Required if using Https.  Paste the text from TLS certificate. Starts with    -----BEGIN CERTIFICATE-----",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": ""
                            },
                            "visible": true
                        },
                        {
                            "name": "HttpsCertificate2",
                            "type": "Microsoft.Common.FileUpload",
                            "label": "Https Certificate",
                            "toolTip": "",
                            "constraints": {
                              "required": false,
                              "accept": ".txt,.crt"
                            },
                            "options": {
                              "multiple": false,
                              "uploadMode": "file",
                              "openMode": "text",
                              "encoding": "UTF-8"
                            },
                            "visible": true
                        },
                        {
                            "name": "HttpsCertificatePrivateKey",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Https Certificate Private Key",
                            "defaultValue": "",
                            "toolTip": "Required if using Https.  Paste the text from private key for your TLS certificate. Starts with    -----BEGIN PRIVATE KEY-----",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": ""
                            },
                            "visible": true
                        },
                        {
                            "name": "HttpsCertificatePrivateKey2",
                            "type": "Microsoft.Common.FileUpload",
                            "label": "Https Certificate Private Key",
                            "toolTip": "",
                            "constraints": {
                              "required": false,
                              "accept": ".txt,.key"
                            },
                            "options": {
                              "multiple": false,
                              "uploadMode": "file",
                              "openMode": "text",
                              "encoding": "UTF-8"
                            },
                            "visible": true
                        }
                    ],
                    "visible": "[equals(steps('https').HttpsConfigure,'Yes')]"
                }               
                
            ]
        }],
        "outputs": {
            "ProfiseeVersion": "[steps('profisee').ProfiseeVersion]",
            "ProfiseeAdminUserAccount": "[steps('profisee').ProfiseeAdminUserAccount]",
            "ProfiseeLicense": "[steps('profisee').ProfiseeLicense]",
            "ProfiseeACRUserName": "[steps('profisee').ProfiseeACRUserName]",
            "ProfiseeACRPassword": "[steps('profisee').ProfiseeACRPassword]",
            "ActiveDirectoryCreateApp": "[steps('ad').ActiveDirectoryCreateApp]",
            "ActiveDirectoryClientId": "[steps('ad').ActiveDirectoryClientId]",
            "ManagedIdentityName": "[steps('ad').ManagedIdentityName]",
            "ManagedIdentityResourceGroup": "[steps('ad').ManagedIdentityResourceGroup]",
            "KubernetesClusterName": "[kubernetes('KubernetesClusterName')]",
            "KubernetesLinuxVMSize": "[kubernetes('KubernetesLinuxVMSize')]",
            "KubernetesWindowsVMSize": "[kubernetes('KubernetesWindowsVMSize')]",
            "KubernetesVersion": "[kubernetes('KubernetesVersion')]",
            "KubernetesVnetName": "[kubernetes('KubernetesVnetName')]",
            "KubernetesVnetResourceGroup": "[kubernetes('KubernetesVnetResourceGroup')]",
            "KubernetesSubnetName": "[kubernetes('KubernetesSubnetName')]",
            "KubernetesServiceCidr": "[kubernetes('KubernetesServiceCidr')]",
            "KubernetesDNSServiceIP": "[kubernetes('KubernetesDNSServiceIP')]",
            "KubernetesDockerBridgeCidr": "[kubernetes('KubernetesDockerBridgeCidr')]",
            "SQLServerCreateNew": "[sql('SQLServerCreateNew')]",
            "SQLServerName": "[sql('SQLServerName')]",
            "SQLServerUser": "[sql('SQLServerUser')]",
            "SQLServerPassword": "[sql('SQLServerPassword')]",
            "SQLServerDatabaseName": "[sql('SQLServerDatabaseName')]",
            "StorageAccountCreateNew": "[storage('StorageAccountCreateNew')]",
            "StorageAccountName": "[storage('StorageAccountName')]",
            "StorageAccountAccessKey": "[storage('StorageAccountAccessKey')]",
            "StorageAccountType": "[storage('StorageAccountType')]",
            "StorageAccountFileShareName": "[basistoragecs('StorageAccountFileShareName')]",
            "DNSUpdate": "[dns('DNSUpdate')]",
            "DNSHostName": "[dns('DNSHostName')]",
            "DNSDomainName": "[dns('DNSDomainName')]",
            "DNSDomainResourceGroup": "[dns('DNSDomainResourceGroup')]",
            "HttpsConfigure": "[https('HttpsConfigure')]",
            "HttpsCertificate": "[https('HttpsCertificate')]",
            "HttpsCertificatePrivateKey": "[https('HttpsCertificatePrivateKey')]"
        }
    }
}