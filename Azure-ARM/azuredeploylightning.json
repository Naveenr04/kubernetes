{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "ProfiseeVersion": {
            "defaultValue": "2020R2.0",
            "type": "String",
            "allowedValues": [
                "2020R1.0",
				"2020R1.1",
                "2020R2.0"
            ],
            "metadata": {
                "description": "Version of the Profisee platform to use."
            }
        },
        "ProfiseeAdminUserAccount": {
            "defaultValue": "first.last@company.com",
            "type": "String",
            "metadata": {
                "description": "Name of the account of the first super user who will be registered in the Profisee platform, who will be able to logon and add other users."
            }
        },
        "ProfiseeLicense": {
            "type": "String",
            "metadata": {
                "description": "Profisee platform license string supplied by Profisee support."
            }
        },                      
         "ManagedIdentityName": {
            "type": "String",
            "metadata": {
                "description": "Existing user assigned Managed Identity with contributer access at the subscription level or contributor access to the resource group this is deployed to and the resource group the domain is in if updating dns.  If Active Directory Create Application is Yes, then it must also have Application Developer role in order to create and configure the azure active directory application."
            }
        },
         "ManagedIdentityResourceGroup": {
            "defaultValue": "[resourceGroup().name]",
            "type": "String",
            "metadata": {
                "description": "Resource group the managed identity was created in."
            }
        },        
        "KubernetesLinuxNodeSize": {
            "defaultValue": "Standard_D2_v3",
            "type": "String",
            "metadata": {
                "description": "Size of the VM to use for the linux node(s) in the kubernetes cluster."
            }
        },
        "KubernetesLinuxNodeCount": {
            "defaultValue": "1",
            "type": "String",            
            "metadata": {
                "description": "Amount of the nodes to create in the Linux node pool."
            }
        },
        "KubernetesWindowsNodeSize": {
            "defaultValue": "Standard_D4_v3",
            "type": "String",
            "metadata": {
                "description": "Size of the VM to use for the Windows node(s) in the kubernetes cluster."
            }
        }, 
        "KubernetesWindowsNodeCount": {
            "defaultValue": "1",
            "type": "String",            
            "metadata": {
                "description": "Amount of the nodes to create in the Windows node pool."
            }
        },               
        "SQLServerName": {
            "defaultValue": "mysqlservername",
            "type": "String",
            "metadata": {
                "description": "Enter a unique sql server name.  Can contain only lowercase letters, numbers, and '-', but can't start or end with '-' or have more than 63 characters and be an available sqlserver name in azure.  SQL Server names are globally unique in Azure"
            }
        },        
        "SQLServerUser": {
            "defaultValue":"sqladmin",
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Administrator SQL login name to create with the new sql server or to use to connect to existing sql server.  Your login name must not contain a SQL Identifier or a typical system name (like admin, administrator, sa, root, dbmanager, loginmanager, etc.) or a built-in database user or role (like dbo, guest, public, etc.).  Your login name must not include non-alphanumeric characters.  Your login name must not start with numbers or symbols"
            }
        },
        "SQLServerPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for sql server user.  The password does not contain the account name of the user and must be at least eight characters long and be no more than 128 characters in length.  The password contains characters from three of the following four categories: Latin uppercase letters (A through Z).  Latin lowercase letters (a through z).  Base 10 digits (0 through 9).  Non-alphanumeric characters such as: exclamation point (!), dollar sign ($), number sign (#), or percent (%)."
            }
        },        
        "StorageAccountName": {
            "defaultValue": "mystorageaccountname",
            "type": "String",
            "metadata": {
                "description": "Enter a unique name.  Can contain only lowercase letters and numbers. Name must be between 3 and 24 characters.  Storage account names are globally unique in Azure"
            }
        }               
    },
    "variables": 
    {
        "ScriptURL":"https://raw.githubusercontent.com/profiseedev/kubernetes/master/Azure-ARM/deployprofisee.sh",
        "KubernetesVnetResourceGroup":"",
        "vnetId":"",
        "PROFISEEVERSION":"[parameters('ProfiseeVersion')]",
        "ADMINACCOUNTNAME":"[parameters('ProfiseeAdminUserAccount')]",
        "LICENSEDATA":"[parameters('ProfiseeLicense')]",
        "ACRUSER":"",
        "ACRUSERPASSWORD":"",

        "UPDATEAAD":"Yes",
        "CLIENTID":"",
        "OIDCURL":"[concat('https://login.microsoftonline.com/',subscription().tenantId)]",

        "KubernetesVersion":"",
        "KubernetesClusterName": "[concat(resourceGroup().name,'ProfiseeCluster')]",

        "KubernetesServiceCidr": "",
        "KubernetesDNSServiceIP": "",
        "KubernetesDockerBridgeCidr": "",
        "KubernetesLinuxNodeCount": "[int(parameters('KubernetesLinuxNodeCount'))]",
        "KubernetesLinuxNodeSize": "[parameters('KubernetesLinuxNodeSize')]",
        "KubernetesWindowsNodeCount": "[int(parameters('KubernetesWindowsNodeCount'))]",
        "KubernetesWindowsNodeSize": "[parameters('KubernetesWindowsNodeSize')]",

        "ManagedIdentityResourceGroup": "[parameters('ManagedIdentityResourceGroup')]",
        "ManagedIdentityName": "[parameters('ManagedIdentityName')]",

        "DNSHostName": "",
        "DNSDomainName": "",
	    "ExternalDNSName": "[concat(variables('DNSHostName'),'.',variables('DNSDomainName'))]",
        "ExternalDNSURL":"[concat('https://',variables('ExternalDNSName'))]",
        "DOMAINNAMERESOURCEGROUP":"",
        "DNSUpdate":"No",
        
        "SQLServerCreateNew" : "Yes",
        "SQLServerName":"[parameters('SQLServerName')]",
        "SQLNAME": "[if(equals(variables('SQLServerCreateNew'),'Yes'), concat(variables('SQLServerName'),'.database.windows.net'),variables('SQLServerName'))]",
        "SQLDBNAME":"Profisee",
        "SQLUSERPASSWORD":"[parameters('SQLServerPassword')]",
        "SQLUSERNAME":"[parameters('SQLServerUser')]",

        "StorageAccountCreateNew" : "Yes",
        "STORAGEACCOUNTNAME":"[parameters('StorageAccountName')]",
        "FILEREPOPASSWORD":"",
        "STORAGEACCOUNTFILESHARENAME":"files",        
        
        "CONFIGUREHTTPS":"No",
        "TLSCERT":"",
        "TLSKEY":"",
                
        "USELETSENCRYPT":"Yes",
        "KubenetesInfrastructureResourceGroupName":"[concat('MC_',resourceGroup().name,'_', variables('KubernetesClusterName'), '_',resourceGroup().location)]"
    },
    "resources": [
        {
            "type": "Microsoft.ContainerService/managedClusters",
            "apiVersion": "2020-07-01",
            "name": "[variables('KubernetesClusterName')]",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "Basic",
                "tier": "Free"
            },
            "properties": {
                "kubernetesVersion": "[variables('KubernetesVersion')]",
                "dnsPrefix": "profisee",
                "agentPoolProfiles": [
                    {
                        "name": "nplinux1",
                        "count": "[variables('KubernetesLinuxNodeCount')]",
                        "vmSize": "[variables('KubernetesLinuxNodeSize')]",
                        "osDiskSizeGB": 100,
                        "maxPods": 30,
                        "type": "VirtualMachineScaleSets",
                        "orchestratorVersion": "[variables('KubernetesVersion')]",
                        "enableNodePublicIP": false,
                        "nodeLabels": {},
                        "mode": "System",
                        "osType": "Linux",
                        "vnetSubnetID": "[if(not(empty(variables('KubernetesVnetResourceGroup'))),variables('vnetId'),json('null'))]"
                    },
                    {
                        "name": "npwin1",
                        "count": "[variables('KubernetesWindowsNodeCount')]",
                        "vmSize": "[variables('KubernetesWindowsNodeSize')]",
                        "osDiskSizeGB": 100,
                        "maxPods": 30,
                        "type": "VirtualMachineScaleSets",
                        "orchestratorVersion": "[variables('KubernetesVersion')]",
                        "enableNodePublicIP": false,
                        "mode": "User",
                        "osType": "Windows",
                        "vnetSubnetID": "[if(not(empty(variables('KubernetesVnetResourceGroup'))),variables('vnetId'),json('null'))]"
                    }
                ],
                "linuxProfile": {
                    "adminUsername": "azureuser",
                    "ssh": {
                        "publicKeys": [
                            {
                                "keyData": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDOJtY73a8o8/+lSlrEycIchV77zZJeXHZT1+Lvhf97yrmPIU5hiVDLm3z8gD8sxi5VSQ7K3KvTbI7ssNUruXCVSWziDl2jTxOVfGo9faneP1dXGDnU7sRvRHHZ+9xwzh4zGdX4eMWZf1Szh8868f7KBn93mZJZt4Z3uQKJJZuDIveAeYMNQrOi1KGwRPNIOpK3Mu/TzDPo0q51mOYM7KoB0HsZmgWVVMY7vFnwWZGnBOS3QJEZKd369mFgDZ42h3p3gDkcMN76naApSnfCqTZMJ9jr1w0wSNw21IKMFCHph2t5kOPMNQCTq3uA4tbkWHMHyxrXgqBOKHgmVXNFF2BT"
                            }
                        ]
                    }
                },
                "windowsProfile": {
                    "adminUsername": "winadmin",
                    "adminPassword": "Ple@seCh@ngeMe1234!"
                },                
                "nodeResourceGroup": "[variables('KubenetesInfrastructureResourceGroupName')]",
                "enableRBAC": true,
                "networkProfile": {
                    "networkPlugin": "azure",
                    "loadBalancerSku": "Standard",
                    "outboundType": "loadBalancer",
                    "serviceCidr": "[variables('KubernetesServiceCidr')]",
                    "dnsServiceIP": "[variables('KubernetesDNSServiceIP')]",
                    "dockerBridgeCidr": "[variables('KubernetesDockerBridgeCidr')]"
                }
            },
            "identity": {
                "type": "SystemAssigned"
            }
        },
        {
            "type": "Microsoft.ContainerService/managedClusters/agentPools",
            "apiVersion": "2020-07-01",
            "name": "[concat(variables('KubernetesClusterName'), '/nplinux1')]",
            "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', variables('KubernetesClusterName'))]"
            ],
            "properties": {
                "count": "[variables('KubernetesLinuxNodeCount')]",
                "vmSize": "[variables('KubernetesLinuxNodeSize')]",
                "osDiskSizeGB": 100,
                "maxPods": 30,
                "type": "VirtualMachineScaleSets",
                "orchestratorVersion": "[variables('KubernetesVersion')]",
                "enableNodePublicIP": false,
                "nodeLabels": {},
                "mode": "System",
                "osType": "Linux"
            }
        },
        {
            "type": "Microsoft.ContainerService/managedClusters/agentPools",
            "apiVersion": "2020-07-01",
            "name": "[concat(variables('KubernetesClusterName'), '/npwin1')]",
            "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', variables('KubernetesClusterName'))]"
            ],
            "properties": {
                "count": "[variables('KubernetesWindowsNodeCount')]",
                "vmSize": "[variables('KubernetesWindowsNodeSize')]",
                "osDiskSizeGB": 100,
                "maxPods": 30,
                "type": "VirtualMachineScaleSets",
                "orchestratorVersion": "[variables('KubernetesVersion')]",
                "enableNodePublicIP": false,
                "mode": "User",
                "osType": "Windows"
            }
        },
        {
            "condition": "[equals(tolower(variables('SQLServerCreateNew')),tolower('Yes'))]",
            "name": "[tolower(variables('SQLServerName'))]",
            "type": "Microsoft.Sql/servers",
            "location": "[resourceGroup().location]",
            "apiVersion": "2019-06-01-preview",
            "dependsOn": [],
            "tags": {
                "displayName": "SQLServer"
            },
            "properties": {
                "administratorLogin": "[variables('SQLUSERNAME')]",
                "administratorLoginPassword": "[variables('SQLUSERPASSWORD')]"
            },
            "resources": [
                {
                    "condition": "[equals(tolower(variables('SQLServerCreateNew')),tolower('Yes'))]",
                    "name": "AllowAllWindowsAzureIps",
                    "type": "firewallrules",
                    "location": "[resourceGroup().location]",
                    "apiVersion": "2015-05-01-preview",
                    "dependsOn": [
                        "[concat('Microsoft.Sql/servers/', tolower(variables('SQLServerName')))]"
                    ],
                    "properties": {
                        "startIpAddress": "0.0.0.0",
                        "endIpAddress": "0.0.0.0"
                    }
                }
            ]
        },
        {
            "condition": "[equals(tolower(variables('StorageAccountCreateNew')),tolower('Yes'))]",
            "name": "[tolower(variables('StorageAccountName'))]",
            "type": "Microsoft.Storage/storageAccounts",
            "location": "[resourceGroup().location]",
            "apiVersion": "2019-06-01",
            "dependsOn": [],
            "tags": {
                "displayName": "[variables('StorageAccountName')]"
            },
            "sku": {
                "name": "Standard_LRS"
            },
            "kind": "StorageV2"
        },
        {
            "condition": "[equals(tolower(variables('StorageAccountCreateNew')),tolower('Yes'))]",
            "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
            "apiVersion": "2019-06-01",
            "name": "[concat(tolower(variables('StorageAccountName')), '/default/', tolower(variables('StorageAccountFileShareName')))]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', tolower(variables('StorageAccountName')))]"
            ]
        },          
        {
        "type": "Microsoft.Resources/deploymentScripts",
        "apiVersion": "2019-10-01-preview",
        "name": "InstallProfiseePlatform",
        "location": "[resourceGroup().location]",
        "kind": "AzureCLI",
         "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', variables('KubernetesClusterName'))]"
            ],
        "identity": {
            "type": "userAssigned",
            "userAssignedIdentities": {
                "[concat('/subscriptions/',subscription().subscriptionId,'/resourcegroups/',variables('ManagedIdentityResourceGroup'),'/providers/Microsoft.ManagedIdentity/userAssignedIdentities/',variables('ManagedIdentityName'))]":{}
            }
        },
        "properties": {
            "forceUpdateTag": "[guid(resourceGroup().id)]",
            "azCliVersion": "2.0.80",
            "timeout": "PT1H",
            "cleanupPreference": "OnExpiration",
            "retentionInterval": "P30D",
            "environmentVariables": [
                {
                    "name": "RESOURCEGROUPNAME",
                    "value": "[resourceGroup().name]"
                },               
                {
                    "name": "CLUSTERNAME",
                    "value": "[variables('KubernetesClusterName')]"
                },
                {
                    "name": "SQLNAME",
                    "value": "[variables('SQLNAME')]"
                },
                {
                    "name": "SQLUSERNAME",
                    "value": "[variables('SQLUSERNAME')]"
                },
                {
                    "name": "SQLUSERPASSWORD",
                    "value": "[variables('SQLUSERPASSWORD')]"
                },
                {
                    "name": "SQLDBNAME",
                    "value": "[variables('SQLDBNAME')]"
                },
                {
                    "name": "STORAGEACCOUNTNAME",
                    "value": "[variables('STORAGEACCOUNTNAME')]"
                },
                {
                    "name": "STORAGEACCOUNTFILESHARENAME",
                    "value": "[variables('StorageAccountFileShareName')]"
                },
                {
                    "name": "ADMINACCOUNTNAME",
                    "value": "[variables('ADMINACCOUNTNAME')]"
                },
                {
                    "name": "DNSHOSTNAME",
                    "value": "[variables('DNSHostName')]"
                },
                {
                    "name": "DNSDOMAINNAME",
                    "value": "[variables('DNSDomainName')]"
                },
                {
                    "name": "DOMAINNAMERESOURCEGROUP",
                    "value": "[variables('DOMAINNAMERESOURCEGROUP')]"
                },
                {
                    "name": "UPDATEDNS",
                    "value": "[variables('DNSUpdate')]"
                },
                {
                    "name": "EXTERNALDNSNAME",
                    "value": "[variables('ExternalDNSName')]"
                },
                {
                    "name": "EXTERNALDNSURL",
                    "value": "[variables('ExternalDNSURL')]"
                },                
                {
                    "name": "OIDCURL",
                    "value": "[variables('OIDCURL')]"
                },
                {
                    "name": "LICENSEDATA",
                    "value": "[variables('LICENSEDATA')]"
                },
                {
                    "name": "ACRUSER",
                    "value": "[variables('ACRUSER')]"
                },
                {
                    "name": "ACRUSERPASSWORD",
                    "value": "[variables('ACRUSERPASSWORD')]"
                },
                {
                    "name": "TLSCERT",
                    "value": "[variables('TLSCERT')]"
                },
                {
                    "name": "TLSKEY",
                    "value": "[variables('TLSKEY')]"
                },
                {
                    "name": "PROFISEEVERSION",
                    "value": "[variables('PROFISEEVERSION')]"
                },
                {
                    "name": "UPDATEAAD",
                    "value": "[variables('UPDATEAAD')]"
                },
                {
                    "name": "CLIENTID",
                    "value": "[variables('CLIENTID')]"
                },
                {
                    "name": "CONFIGUREHTTPS",
                    "value": "[variables('CONFIGUREHTTPS')]"
                }
                ,
                {
                    "name": "FILEREPOPASSWORD",
                    "value": "[variables('FILEREPOPASSWORD')]"
                }
                ,
                {
                    "name": "USELETSENCRYPT",
                    "value": "[variables('USELETSENCRYPT')]"
                }
                ,
                 {
                    "name": "AKSINFRARESOURCEGROUPNAME",
                    "value": "[variables('KubenetesInfrastructureResourceGroupName')]"
                },
                {
                    "name": "SQLSERVERCREATENEW",
                    "value": "[variables('SQLServerCreateNew')]"
                }

            ],
            "primaryScriptUri": "[variables('ScriptURL')]"            
        }
        },
        {
            "apiVersion": "2018-02-01",
            "name": "pid-498552cf-87f5-55b7-a69b-5364df5c1994",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        }       
        
    ],
    "outputs": 
    {
    "InstallProfiseePlatformOutputs": {
      "value": "[reference('InstallProfiseePlatform').outputs]",
      "type": "object"
    },
    "KubernetesClusterFQDN": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('KubernetesClusterName'))).FQDN]"
        }
  }
}
